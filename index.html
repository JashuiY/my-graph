<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>INDICADORES</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      background: #f8f8f8; 
    }
    .controls, .right-buttons { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      margin-bottom: 20px; 
    }
    .right-buttons { 
      flex-direction: column; 
      margin-left: 40px; 
    }
    .toggle { 
      cursor: pointer; 
      border: 1px solid #ccc; 
      padding: 6px 10px; 
      border-radius: 6px; 
      background: white; 
    }
    .toggle.active { 
      background-color: #007bff; 
      color: white; 
    }
    .btn { 
      padding: 8px 12px; 
      background: #e6f3e6; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      cursor: pointer; 
      width: 100px; 
      text-align: center; 
    }
    .btn.active { 
      background: green; 
      color: white; 
      font-weight: bold; 
    }
    #chart-container { 
      display: flex; 
    }
    #chart { 
      width: 700px; 
      height: 400px; 
    }
    .contenedor {
      display: flex;
      gap: 20px; /* Espacio entre gráficos */
      margin-bottom: 20px;
      margin-left: auto;
      margin-right: auto;
      width: 100%;
      align-items: center;
    }
    .contenedor_2 {
      display: flex;
      gap: 20px; /* Espacio entre gráficos */
      margin-bottom: 20px;
      /*margin-left: auto;*/
      margin-right: auto;
      width: 50%;
      align-items: center;
    }
    .botones{
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      justify-content: center;
      gap: 10px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 40px;
      margin-top: 0px;
    }
    .grafica {
      flex: 1;
      height: 500px;
    }
    #mapa {
      flex: 1;
      max-width: 60%;
    }
    #desempeños {
      flex: 1;
      max-width: 40%;
    }
    #indicadores_1 {
      height: 700px;
    }
    #indicadores_2 {
      height: 650px;
    }
    button{
      min-width: 120px;
      width: 15%;/*130px;*/
      height: 50px;
      padding: 10px 5px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      background-color: #F0F0F0;/*#FF9800;*/
      color: black;
      box-shadow: 0 5px 0 #149985, 0 8px 10px rgba(0, 0, 0, 0.2); /*F57C00 - D0F2E1*/
      position: relative;
      top: 0;
      transition: all 0.1s;

      display: flex;
      justify-content: center;
      align-items: center;
      text-overflow: ellipsis;
      overflow: hidden;
      line-height: 1.1;
    }
    button:hover{
      background-color: #149985;/*#FB8C00;*/
      color: white;
      transform: translateY(-3px);
    }
    button:active{
      top: 3px;
    }
    button.activo {
      background-color: #149985 !important;
      color: white;
      transform: translateY(3px);
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.2);
    }
    #loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .loader {
      border: 10px solid #f3f3f3;
      border-top: 10px solid #006657;/*#FF9800;*/
      border-radius: 50%;
      width: 80px;
      height: 80px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loader-overlay">
    <div class="loader"></div>
  </div>
  <div class="contenedor">
    <div class="botones" id="botones1" style="width: 100%; margin-bottom: 83px;"></div>
    <div class="botones" id="botones2" style="width: 13%;"></div>
  </div>

  <div class="contenedor">
    <!---
    <div id="mapa" class="grafica"></div>
    --->
    <div id="desempeños" class="grafica"></div>
  </div>

  <div class="contenedor">
    <div id="indicadores_1" class="grafica"></div>
  </div>

  <div class="contenedor">
    <div id="indicadores_2" class="grafica"></div>    
  </div>

  <div id="analisis_1" hidden>
    <div class="contenedor">
      <b style="font-family: 'Noto Sans'; font-size: 32px;">Análisis</b>
    </div>

    <div class="contenedor">
      <table id="tabla" style="font-family: 'Noto Sans'; font-size: 16px; border-collapse: collapse; width: 100%;">
          <thead id="encabezado_tabla">
            <tr style="background-color: 'rgba(0,0,0,0)';">
              <th style="padding: 8px; border: 1px none; width: 50%; text-align:left; font-size:25px;">Indicadores cercanos a cambiar.</th>
              <th style="padding: 8px; border: 1px none; width: 50%; text-align:left; font-size:25px;">-.</th>
            </tr>
          </thead>
          <tbody id="cuerpo_tabla">
          </tbody>
        </table>
    </div>

    <div class="contenedor">
      <div class="contenedor_2">
        <table id="tabla_1" style="font-family: 'Noto Sans'; font-size: 14px; border-collapse: collapse; width: 80%;">
          <thead>
            <tr style="background-color: #f0f0f0;">
              <th style="padding: 8px; border: 1px none #ccc;" rowspan="1"; >Indicador</th>
              <th style="padding: 8px; border: 1px none #ccc;" rowspan="1"; >Valor</th>
              <th style="padding: 8px; border: 1px none #ccc;" rowspan="1"; >Error</th>
              <th style="padding: 8px; border: 1px none #ccc;" colspan="1"; >Semaforización</th>
            </tr>
            <!---
            <tr style="background-color: #f0f0f0;">
              <th style="padding: 8px; border: 1px none #ccc;">Actual</th>
              <th style="padding: 8px; border: 1px none #ccc;">Posible</th>
            </tr>
            --->
          </thead>
          <tbody id="cuerpo_tabla_1">
            <!-- Las filas se llenarán desde JavaScript -->
          </tbody>
        </table>
      </div>
      <!--- --->
    </div>
  </div>

  <script>
  function insertarSaltosLinea(text, maxLineLength) {
    const words = text.split(' ');
    let line = '';
    let result = '';

    for (let word of words) {
      if ((line + word).length > maxLineLength) {
        result += line.trim() + '<br>';
        line = '';
      }
      line += word + ' ';
    }

    result += line.trim(); // Agrega la última línea
    return result;
  }

  function calcularError(numero, rango){
    if (Array.isArray(rango)){
      if (Array.isArray(rango[0])){
        err1 = numero - rango[0][0];
        err2 = numero - rango[0][1];
        err3 = numero - rango[1][0];
        err4 = numero - rango[1][1];
        errores = [err1, err2, err3, err4];
        errores_abs = [Math.abs(err1), Math.abs(err2), Math.abs(err3), Math.abs(err4)];
        error_ = Math.min(...errores_abs);
        index = errores_abs.indexOf(error_);
        error = errores[index];
      } else{
        err1 = numero - rango[0];
        err2 = numero - rango[1];
        error = (Math.abs(err1) < Math.abs(err2)) ? err1 : err2;
      }
    } else {
      error = numero - rango;
    }
    return error;
  }

  function obtenerRangoNumero(valor){
    if (valor == null || valor === "") {
      return null;
    }
    valor = valor.toString();
    valor = valor.trim();

    if (valor.includes("o")) {
      const partes = valor.split("o").map(v => v.trim());
      return partes.map(parte => obtenerRangoNumero(parte)); // Recursivo para limpiar cada parte
    }

    if (valor.includes("-")) {
      const partes = valor.split("-").map(v => parseFloat(v.trim()));
      return [partes[0], partes[1]];
    } else if (valor.startsWith(">=")) {
      return parseFloat(valor.substring(2).trim()) // { tipo: "mayorIgual", valor: parseFloat(valor.substring(2).trim()) };
    } else if (valor.startsWith("<=")) {
      return parseFloat(valor.substring(2).trim()) // { tipo: "menorIgual", valor: parseFloat(valor.substring(2).trim()) };
    } else if (valor.startsWith(">")) {
      return parseFloat(valor.substring(1).trim()) // { tipo: "mayor", valor: parseFloat(valor.substring(1).trim()) };
    } else if (valor.startsWith("<")) {
      return parseFloat(valor.substring(1).trim()) // { tipo: "menor", valor: parseFloat(valor.substring(1).trim()) };
    } else {
      return parseFloat(valor);
    }
  }

  function evaluarCondicion(numero, condicionTexto) {
    if (!condicionTexto) return false;
    // Normalizar: quitar espacios, pasar a minúscula
    condicionTexto = condicionTexto.toLowerCase().replace(/\s+/g, "");
    // console.log('evaluando..', numero, condicionTexto)
    // Dividir por "o" (también podrías usar "|" o "," si quisieras)
    const condiciones = condicionTexto.split("o");
    // Evaluar cada subcondición
    return condiciones.some(cond => {
      if (/^\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'===', cond)
        return numero === parseFloat(cond);

      } else if (/^<=\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'<=', cond.slice(2))
        return numero <= parseFloat(cond.slice(2));

      } else if (/^>=\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'>=', cond.slice(2))
        return numero >= parseFloat(cond.slice(2));

      } else if (/^<\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'<', cond.slice(1))
        return numero < parseFloat(cond.slice(1));

      } else if (/^>\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'>', cond.slice(1))
        return numero > parseFloat(cond.slice(1));

      } else if (/^\d+(\.\d+)?-\d+(\.\d+)?/.test(cond)) {
        const [inicio, fin] = cond.split("-").map(Number);
        //console.log(numero,'>=', inicio, '&&', numero, '<=', fin)
        return numero >= inicio && numero <= fin;
      }
      return false;
    });
  }  
  
  function calcularColor(valor, esperado, medio, bajo) {
    if (evaluarCondicion(valor, esperado)) {
      return "green";
    } else if (evaluarCondicion(valor, medio)) {
      return "orange";
    } else if (evaluarCondicion(valor, bajo)) {
      return "red";
    } else {
      return "white";
    }
  }

  function filtrarUnidadFecha(datos, unidadSeleccionada, fechaSeleccionada) {
    return datos.filter(d =>
      d.unidad === unidadSeleccionada && d.fecha === fechaSeleccionada
    );
  }

  function filtrarDesempeño(datos, colorSeleccionado) {
    return datos.filter(d =>
      d.color === colorSeleccionado
    );
  }

  function filtrarUnidadIndicador(datos, unidadSeleccionada, indicadorSeleccionado) {
    return datos.filter(d =>
      d.unidad === unidadSeleccionada && d.indicador === indicadorSeleccionado
    );
  }

  function contarColores(datosFiltrados) {
    const conteo = {
      green: 0,
      red: 0,
      orange: 0,
      white: 0
    };
    datosFiltrados.forEach(d => {
      if (conteo[d.color] !== undefined) {
        conteo[d.color]++;
      }
    });

    return conteo;
  }

  function actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño) {
    const datosFiltrados = filtrarUnidadFecha(datos, unidad_deseada, fecha_deseada);
    const conteo = contarColores(datosFiltrados);
    //const labels = ["Esperado", "Bajo", "Medio", "Sin datos"];
    const pulled = [0, 0, 0, 0];
    const values = [conteo.green, conteo.red, conteo.orange, conteo.white];
    const colors = ["green", "red", "orange", "lightgray"];

    index_color = labels.indexOf(desempeño);
    pulled[index_color] = 0.1;
    n_indicadores = values[index_color];

    titulo = unidad_deseada;
    const reg_exp = /(?<=\d{2})\s/;
    titulo = titulo.replace(reg_exp, "<br>");

    // console.log(datosFiltrados);
    Plotly.react("desempeños", 
      [{
        values: values,
        labels: labels,
        type: "pie",
        marker: {
          colors: colors
        },
        textinfo: "label+percent",
        insidetextorientation: "radial",
        pull: pulled,
        hole: 0.3,
        textfont: {
          size: 18
        },
        hoverinfo: 'none',//'label+percent+value',
        hovertemplate: '', //'<b>%{label}</b><br>%{percent:.1%}<br>Valor: %{value}<extra></extra>',
      }], 
      {
        title: {
          text: `${titulo}`,
          font: {
            size: 24,
            color: "black"
          },
          x: 0.5,
          //position: "center middle"
        },
        annotations: [{  // Texto en el centro
          text: `<b>No.<br>indicadores:<br><br><span style="font-size:30px; margin:25px;">${n_indicadores}</span><b>`,
          font: { family: 'Noto Sans', size: 14, color: '#333' },
          showarrow: false,
          x: 0.5,  // Posición X (0-1)
          y: 0.5,  // Posición Y (0-1)
          xanchor: 'center',
          yanchor: 'middle',
          align: 'center'
        }],
        showlegend: false,
        hoverlabel: {
          shadow: {
            color: 'rgba(0,0,0,0.5)',
            x: 3,
            y: 3,
            blur: 10
          }
        },
        plot_bgcolor: 'rgba(0,0,0,0)', // Fondo transparente
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, b: 40, l: 30, r: 30 }, // Márgenes ajustados
        font: {
          family: 'Noto Sans',
          color: '#333333'
        },
        hovermode: 'closest',
        animations: {
          enabled: true,
          easing: 'elastic-in-out'
        }
      }
    );
    return datosFiltrados;
  }

  function actualizarGrafica3(datosFiltrados, desempeño){
    document.getElementById('analisis_1').hidden = false;

    if (desempeño == labels[0]) {
      color_deseado = 'green';
    } else if (desempeño == labels[1]) {
      color_deseado = 'red';
    } else if (desempeño == labels[2]) {
      color_deseado = 'orange';
    } else {
      color_deseado = 'white';
    }

    const datosFiltrados2 = filtrarDesempeño(datosFiltrados, color_deseado);
    //console.log(datosFiltrados2);
    // Calcular errores y armar nuevo array
    const datosConError = datosFiltrados2.map(row => {
      let esperado, esperado_, desempeño_2, comparadoCon, colorComparado;
      const indicador = row['indicador'];
      const valor = row['valor'];
      const Resperado = row['esperado'];
      const Rmedio = row['medio'];
      const Rbajo = row['bajo'];
      // console.log(indicador, valor);
      errorEsperado = calcularError(valor, Resperado);
      errorMedio = calcularError(valor, Rmedio);
      errorBajo = calcularError(valor, Rbajo);
      //console.log(errorEsperado, errorMedio, errorBajo);
      if (desempeño == 'Bajo') {
        error = (Math.abs(errorMedio) <= Math.abs(errorEsperado)) ? errorMedio : errorEsperado;
        errorColor = (Math.abs(errorMedio) < Math.abs(errorEsperado)) ? 'orange' : 'green';
      } else if (desempeño == 'Medio'){
        error = errorEsperado;
        errorColor = 'green';
      } else if (desempeño == 'Esperado') {
        error = (Math.abs(errorMedio) <= Math.abs(errorBajo)) ? errorMedio : errorBajo;
        errorColor = (Math.abs(errorMedio) < Math.abs(errorBajo)) ? 'orange' : 'red';
      }
      // console.log(error, errorColor, '-------');
      valor_esperado = valor - error;
      return {
        indicador: indicador,
        error: error,
        valor: valor,
        limite: valor_esperado,
        limite_: esperado_,
        colorError: errorColor,
      };
    });

    // Ordenar por valor absoluto del error de menor a mayor
    const datosConError2 = datosConError.sort((a, b) => Math.abs(a.error) - Math.abs(b.error));
    console.log(datosConError, datosConError2);
    /*
    */
    // Crear arrays para la gráfica
    const indicadores = datosConError.map(row => row.indicador);
    const valores = datosConError.map(row => row.valor);
    const errores = datosConError.map(row => row.error);
    const limites = datosConError.map(row => row.limite);
    const limites_ = datosConError.map(row => row.limite_);
    const colores_ = datosConError.map(row => row.colorError);
    const textos = valores.map((valor, i) => {
      const error_ = errores[i];
      const signo_ = error >= 0 ? "▲" : "▼"; // Usa el signo correcto
      return `${valor.toFixed(2)} (${signo_}${Math.abs(error_).toFixed(2)})`;
    });
    // console.log(valores, textos, limites);
    // console.log(datosFiltrados2);
    Plotly.react("indicadores_1", 
      [
        {
          type: "bar",
          x: indicadores,
          y: valores,
          text: textos,
          textposition: 'outside',
          cliponaxis: false,
          texttemplate: '<b>%{y:.1f}</b>',
          textangle: -45,
          textfont: { size: 18, family: 'Noto Sans' },
          marker: { color: color_deseado },
          hovertemplate: '<b>%{label}</b><br>%{text}<extra></extra>',
          hoverlabel: {
            bgcolor: color_deseado,
            //bordercolor: '#000000',
            font: { family: 'Noto Sans', color: (color_deseado=='orange' ? 'black':'white'), size: 20}
          },
          margin: { b: 150 },
          showlegend: false
        },
        // Línea de pasos (valores esperados)
        {
          type: "scatter",
          mode: "lines+markers",
          x: indicadores,
          y: limites,
          name: "Valor esperado",
          line: {
            shape: "hvh",  // step graph: horizontal-vertical
            color: 'black',
            width: 2,
            dash: 'dot' // (dot, dash)
          },
          marker: {
            color: colores_,
            symbol: 'circle' //"cross-thin"
            //size: 15
          },
          //hovertemplate: "<b>%{x}</b><br>Esperado: %{y}<extra></extra>"
          hovertemplate: "",
          showlegend: false
        }
      ], {
        title: {
          text: `Indicadores con desempeño ${desempeño}, ${mes_deseado} ${año_deseado}`,
          font: { size: 24, color: "black" },
          x: 0.5
        },
        //xaxis: { title: "Indicador" },
        yaxis: { title: "Valor" },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: '#f9f9f9',
        shadow: {
          enabled: true,
          color: 'rgba(0,0,0,0.2)',
          x: 3,
          y: 3,
          blur: 10
        },
        uniformtext: {
          //mode: 'hide', // Oculta etiquetas que no caben
          minsize: 14   // Tamaño mínimo de fuente
        }
      }
    );

    const cuerpoTabla_1 = document.getElementById("cuerpo_tabla_1");
    cuerpoTabla_1.innerHTML = "";
    obs_indicadores = (indicadores.length < 5) ? indicadores.length : 5;
    for (i = 0; i < obs_indicadores; i++){
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td style="padding: 4px; border: 1px solid #ccc;">${indicadores[i]}</td>
        <td style="padding: 4px; border: 1px solid #ccc; text-align: center";>${valores[i].toFixed(2)}</td>
        <td style="padding: 4px; border: 1px solid #ccc; text-align: center";>${errores[i].toFixed(2)}</td>
        <td style="padding: 1px; border: 1px solid #ccc; font-size:40px; text-align:center;"><span style="color: ${color_deseado};">■</span><span style="font-size:25px;">➔</span><span style="color: ${colores_[i]};">■</span></td>
        
      `;
      // <td style="padding: 1px; border: 1px solid #ccc; font-size:40px; text-align:center; color:${colores_[i]};">■</td>
      cuerpoTabla_1.appendChild(fila);
      //document.getElementById('texto_1').innerHTML += (`<br>${} &ensp; Le falta ${} para llegar al nivel ${desempeño_2}.`);      
    }
    return indicadores;
  }

  function actualizarGrafica4(datos, unidad_deseada, indicador_deseado){
    const datosFiltrados3 = filtrarUnidadIndicador(datos, unidad_deseada, indicador_deseado);
    console.log(unidad_deseada, indicador_deseado);
    // Crear arrays para la gráfica
    const fechas = datosFiltrados3.map(row => row['fecha']);
    const valores = datosFiltrados3.map(row => row['valor']);
    const colores = datosFiltrados3.map(row => row['color']);
    const textos = datosFiltrados3.map(row => row['valor'].toFixed(2));
    const nombres_indicadores = datosFiltrados3.map(row => row['nombre_indicador']);
    // console.log(textos);
    const nombre_indicador = nombres_indicadores[0];
    const nombre_formateado = insertarSaltosLinea(nombre_indicador, 80);
    Plotly.react("indicadores_2", [{
      type: "bar",
      x: fechas,
      y: valores,
      text: textos,
      textposition: 'auto',
      texttemplate: '<b>%{y:.2f}<b>',
      //textangle: -90,
      textfont: { size: 18, family: 'Noto Sans' },
      marker: { color: colores },
      hovertemplate: '<b>%{label}</b><br>%{value}<extra></extra>',
      hoverlabel: {
        bgcolor: colores,
        //bordercolor: '#000000',
        font: { family: 'Noto Sans', color: (color_deseado=='orange' ? 'black':'white'), size: 20}
      },
      showlegend: false,
      marker: {
        color: colores 
      }
    }], {
      title: {
        text: `<b><span style="font-size:18px; margin:25px;">${nombre_formateado}</span><br>${indicador_deseado} - ${unidad_deseada}</b><br>`,
        font: {
          size: 20,
          color: "black",
        },
        x: 0.5
      },
      //xaxis: { title: "Fechas" },
      yaxis: { title: "Valor" },     
      margin: { b: 100, t:120 }, 
      plot_bgcolor: 'rgba(0,0,0,0)',
      paper_bgcolor: '#f9f9f9'
    });
  }

  // -------------- COORDENADAS -------------------- //
  latitudes = [16.3673,16.5853,16.4342,16.5548,16.8022,16.2022,16.3296,18.1065,15.7617,18.0829,18.0822,15.7363,17.3319,16.7944,
               17.0782,17.0701,17.0672,16.8664,17.2101,17.2411,17.2818,17.7983,15.8635,18.1312,16.3395,17.6718,17.0723,17.0720];
  longitudes = [-94.1915,-94.7655,-95.0146,-95.0882,-95.0962,-95.2019,-95.2329,-95.8807,-96.1296,-96.1378,-96.1379,-96.4722,-96.4871,-96.6764,
                -96.7043,-96.7220,-96.7358,-96.7863,-96.7980,-96.8207,-96.8925,-96.9602,-97.0703,-97.0765,-98.0453,-97.5652,-96.7212,-96.7207];
  /*unidades = ['UMF 30 San Pedro Tapanatepec','UMF 12 Sto. Domingo Ingenio','UMF 06 Juchitán','UMF 23 Cd. Ixtepec','UMF 29 Barrio La Soledad',
             'HGZMF 02 Salina Cruz','UMF 05 Sto.Dgo.Tehuantepec','UMF 59 Loma Bonita','HGSMF 41 Huatulco','UMF 64 Tuxtepec','HGZ 03 Tuxtepec',
             'UMF 33 Pedro Pochutla','UMF 40 Ixtlan de Juárez','UMF 27 Ocotlán','UMF 65 Sta Lucia del Camino','UMF 01 Oaxaca','UMF 38 FFCC.',
             'UMF 31 Zimatlán de Álvarez','UMF 57 San Pablo Villa de Etla','UMF 17 Magdalena Apasco','UMF 56 San Pablo Huitzo','UMF 13 Cuicatlán',
             'UMF 32 Puerto Escondido','UMF 58 Teotitlán','UMF 26 Pinotepa','UMRM 21 Tamazulapan','HGZ 01 Oaxaca','UMAA Oaxaca'];*/

  unidades1 = ['UMF 01 Oaxaca','UMF 38 FFCC.','UMF 65 Sta Lucia del Camino','UMF 64 Tuxtepec','UMF 13 Cuicatlán','UMF 05 Sto.Dgo.Tehuantepec',
              'UMF 06 Juchitán','UMF 17 Magdalena Apasco','UMF 12 Sto. Domingo Ingenio','UMF 23 Cd. Ixtepec','UMF 27 Ocotlán','UMF 31 Zimatlán de Álvarez',
              'UMF 30 San Pedro Tapanatepec','UMF 40 Ixtlan de Juárez','UMF 32 Puerto Escondido','UMF 33 Pedro Pochutla','UMF 29 Barrio La Soledad',
              'UMF 26 Pinotepa','UMF 58 Teotitlán','UMF 57 San Pablo Villa de Etla','UMF 56 San Pablo Huitzo','UMF 59 Loma Bonita','UMRM 21 Tamazulapan','UMAA Oaxaca'];
  unidades2 = ['HGZ 01 Oaxaca','HGZMF 02 Salina Cruz','HGZ 03 Tuxtepec','HGSMF 41 Huatulco','Oaxaca']

  mes_deseado = 'ENERO';
  año_deseado = '2025';
  fecha_deseada = mes_deseado.concat(' ', año_deseado);
  desempeño = 'Bajo';
  color_deseado = 'red';
  unidad_deseada = 'Oaxaca';
  indicador_deseado = 'DM 01';
  labels = ["Esperado", "Bajo", "Medio", "Sin datos"];
  puntoResaltado = null;
  n_indicadores = "--";

  fetch("https://script.google.com/macros/s/AKfycbxbdwnq17ukuBOPxtHR52a12NcrR4V5LiTujKCPFWMKoYztEFmIBk6pyeyHG2UwVMamog/exec")
    .then(response => response.json())
    .then(data => {
      datos = data.map(row => ({
        fecha: row["FECHA"],
        unidad: row["UNIDAD"],
        ind: row["IND"],
        indicador: row["INDICADOR"],
        nombre_indicador: row["NOMBRE INDICADOR"],
        valor: parseFloat(row["VALOR"]),
        color: calcularColor(row["VALOR"], row["ESPERADO"], row["MEDIO"], row["BAJO"]),
        esperado: obtenerRangoNumero(row['ESPERADO']),
        medio: obtenerRangoNumero(row['MEDIO']),
        bajo: obtenerRangoNumero(row['BAJO']),
        esperado_: row['ESPERADO'],
        medio_: row['MEDIO'],
        bajo_: row['BAJO']
      }));
    // console.log(datos);
    console.log("Termina de preparar los datos. Comienza a graficar.");
    datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño);
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
    document.getElementById('loader-overlay').style.display = 'none';
  });

  Plotly.newPlot("desempeños", 
    [{
        type: "pie",
        values: [1, 0, 0, 0],
        labels: labels,
        marker: {
          colors: ["green", "red", "orange", "lightgray"]
        },
        textinfo: "label+percent",
        insidetextorientation: "radial",
        hole: 0.3,
        textfont: {
          size: 18
        },
        hoverinfo: 'none',//'label+percent+value',
        hovertemplate: '', //'<b>%{label}</b><br>%{percent:.1%}<br>Valor: %{value}<extra></extra>',
      }], 
      {
        title: {
          text: `Oaxaca`,
          font: {
            size: 24,
            color: "black"
          },
          x: 0.5,
        },
        annotations: [{  // Texto en el centro
          text: `<b>No.<br>indicadores:<br><br><span style="font-size:30px; margin:25px;">${n_indicadores}</span><b>`,
          font: { family: 'Noto Sans', size: 14, color: '#333' },
          showarrow: false,
          x: 0.5,  // Posición X (0-1)
          y: 0.5,  // Posición Y (0-1)
          xanchor: 'center',
          yanchor: 'middle',
          align: 'center'
        }],
        showlegend: false,
        hoverlabel: {
          shadow: {
            color: 'rgba(0,0,0,0.5)',
            x: 3,
            y: 3,
            blur: 10
          }
        },
        plot_bgcolor: 'rgba(0,0,0,0)', // Fondo transparente
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, b: 40, l: 30, r: 30 }, // Márgenes ajustados
        font: {
          family: 'Noto Sans',
          color: '#333333'
        },
        hovermode: 'closest',
        animations: {
          enabled: true,
          easing: 'elastic-in-out'
        }
      }
  ); // desempeños

  Plotly.newPlot("indicadores_1", 
    [{
      type: "bar",
      x: ['01', '02', '03', '04'],
      y: [1, 0.75, 0.5, 0.25],
      cliponaxis: false,
      texttemplate: ' ',
      marker: { color: color_deseado },
      hoverlabel: {
        bgcolor: color_deseado,
        font: { family: 'Noto Sans', color: (color_deseado=='orange' ? 'black':'white'), size: 20}
      },
      margin: { b: 150 },
      showlegend: false
    },
    // Línea de pasos (valores esperados)
    {
      type: "scatter",
      mode: "lines+markers",
      x: ['01', '02', '03', '04'],
      y: [1, 0, 0, 0],
      name: "Valor esperado",
      line: {
        shape: "hvh",  // step graph: horizontal-vertical
        color: 'black',
        width: 2,
        dash: 'dot' // (dot, dash)
      },
      marker: {
        color: 'orange',
        symbol: "cross-thin"
      },
      hovertemplate: "",
      showlegend: false
    }], 
    {
      title: {
        text: `Indicadores con desempeño ${desempeño}, ${mes_deseado} ${año_deseado}`,
        font: { size: 24, color: "black" },
        x: 0.5
      },
      yaxis: { title: "Valor" },
      plot_bgcolor: 'rgba(0,0,0,0)',
      paper_bgcolor: '#f9f9f9',
      shadow: {
        enabled: true,
        color: 'rgba(0,0,0,0.2)',
        x: 3,
        y: 3,
        blur: 10
      },
      uniformtext: {
        minsize: 14   // Tamaño mínimo de fuente
      }
    }
  ); // indicadores_1

  Plotly.newPlot("indicadores_2", 
    [{
      y: [1, 0, 0, 0],
      x: ['Enero', 'Febrero', 'Marzo', 'Abril'],
      type: "bar",
      marker: {
        color: color_deseado 
      }
    }], {
      title: {
        text: `${indicador_deseado} - ${unidad_deseada}`,
        x: 0.5
      },
      yaxis: { title: "Valor" },
      plot_bgcolor: 'rgba(0,0,0,0)',
      paper_bgcolor: '#f9f9f9'
    }); // indicadores_2

  console.log('Terminó una gráfica, empezando a comunicarse.');
  document.getElementById('loader-overlay').style.display = 'flex';

  // ---------- 8 -------------
  
  const contenedor1 = document.getElementById("botones1");
  unidades1.forEach(unidad => {
    const btn = document.createElement("button");
    btn.textContent = unidad;

    // Evento click
    btn.addEventListener("click", () => {
      console.log(unidad);
      // Remover la clase activa de todos los botones
      document.querySelectorAll("#botones2 button","#botones1 button").forEach(b => {
        document.querySelectorAll("button").forEach(b => b.classList.remove("activo")); // remover estilo activo a todos.
        btn.classList.add("activo");  // asignar estilo activo solo a uno.        
      });

      unidad_deseada = unidad;
      datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño);
      indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
      actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
    });    
    contenedor1.appendChild(btn);
  });

  const contenedor2 = document.getElementById("botones2");
  unidades2.forEach(unidad => {
    const btn = document.createElement("button");
    btn.textContent = unidad;

    btn.addEventListener("click", () => {
      console.log(unidad);
      // Remover la clase activa de todos los botones
      document.querySelectorAll("#botones1 button", "#botones2 button").forEach(b => {
        document.querySelectorAll("button").forEach(b => b.classList.remove("activo")); // remover estilo activo a todos.
        btn.classList.add("activo");  // asignar estilo activo solo a uno.
      });

      unidad_deseada = unidad;
      datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño);
      indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
      actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
    });    
    contenedor2.appendChild(btn);
  });
    
  document.getElementById("desempeños").on('plotly_click', function(data3) {
    var punto = data3.points[0];
    desempeño = punto.label;
    n_indicadores = punto.value;
    console.log(desempeño);
    // Actualizando Graficas
    datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño);
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
  });

  document.getElementById("indicadores_1").on('plotly_click', function(data4) {
    var punto = data4.points[0];
    indicador_deseado = punto.x;
    console.log('click en:',punto);
    // Actualizando Graficas
    actualizarGrafica4(datos, unidad_deseada, indicador_deseado);
  });
  </script>
</body>
</html>
