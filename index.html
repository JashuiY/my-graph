<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Desde Google Sheets</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      background: #f8f8f8; 
    }
    .controls, .right-buttons { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      margin-bottom: 20px; 
    }
    .right-buttons { 
      flex-direction: column; 
      margin-left: 40px; 
    }
    .toggle { 
      cursor: pointer; 
      border: 1px solid #ccc; 
      padding: 6px 10px; 
      border-radius: 6px; 
      background: white; 
    }
    .toggle.active { 
      background-color: #007bff; 
      color: white; 
    }
    .btn { 
      padding: 8px 12px; 
      background: #e6f3e6; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      cursor: pointer; 
      width: 100px; 
      text-align: center; 
    }
    .btn.active { 
      background: green; 
      color: white; 
      font-weight: bold; 
    }
    #chart-container { 
      display: flex; 
    }
    #chart { 
      width: 700px; 
      height: 400px; 
    }
    .contenedor {
      display: flex;
      gap: 20px; /* Espacio entre gráficos */
      margin-bottom: 20px;
      margin-left: auto;
      margin-right: auto;
      width: 100%;
      align-items: center;
    }
    .grafica {
      flex: 1;
      height: 600px;
    }
    #mapa {
      flex: 1;
      height: 600px;
      max-width: 60%;
    }
    #desempeños {
      flex: 1;
      height: 600px;
      max-width: 40%;
    }
    #indicadores_1 {
      flex: 1;
      height: 600px;
      max-width: 50%;
    }
    /*style="width: 50%; max-width: 900px; height: 500px;"*/
  </style>
</head>
<body>
  <h2><center>INDICADORES – OOAD OAXACA</center></h2>
  <div class="contenedor">
    <div id="mapa" class="grafica"></div>
    <div id="desempeños" class="grafica"></div>
  </div>
  <div class="contenedor">
    <div id="indicadores_1" class="grafica"></div>
    <div id="indicadores_2" class="grafica"></div>
  </div>

  <script>
  function evaluarCondicion(numero, condicionTexto) {
      if (!condicionTexto) return false;
      // Normalizar: quitar espacios, pasar a minúscula
      condicionTexto = condicionTexto.toLowerCase().replace(/\s+/g, "");
      // console.log('evaluando..', numero, condicionTexto)
      // Dividir por "o" (también podrías usar "|" o "," si quisieras)
      const condiciones = condicionTexto.split("o");
      // Evaluar cada subcondición
      return condiciones.some(cond => {
          if (/^\d+(\.\d+)?$/.test(cond)) {
            //console.log(numero,'===', cond)
            return numero === parseFloat(cond);

          } else if (/^<=\d+(\.\d+)?$/.test(cond)) {
            //console.log(numero,'<=', cond.slice(2))
            return numero <= parseFloat(cond.slice(2));

          } else if (/^>=\d+(\.\d+)?$/.test(cond)) {
            //console.log(numero,'>=', cond.slice(2))
            return numero >= parseFloat(cond.slice(2));

          } else if (/^<\d+(\.\d+)?$/.test(cond)) {
            //console.log(numero,'<', cond.slice(1))
            return numero < parseFloat(cond.slice(1));

          } else if (/^>\d+(\.\d+)?$/.test(cond)) {
            //console.log(numero,'>', cond.slice(1))
            return numero > parseFloat(cond.slice(1));

          } else if (/^\d+(\.\d+)?-\d+(\.\d+)?/.test(cond)) {
            const [inicio, fin] = cond.split("-").map(Number);
            //console.log(numero,'>=', inicio, '&&', numero, '<=', fin)
            return numero >= inicio && numero <= fin;
          }
          return false;
      });
  }  
  
  function calcularColor(valor, esperado, medio, bajo) {
  if (evaluarCondicion(valor, esperado)) {
    return "green";
  } else if (evaluarCondicion(valor, medio)) {
    return "orange";
  } else if (evaluarCondicion(valor, bajo)) {
    return "red";
  } else {
    return "white";
  }
  }

  function filtrarUnidadFecha(datos, unidadSeleccionada, fechaSeleccionada) {
    return datos.filter(d =>
      d.unidad === unidadSeleccionada && d.fecha === fechaSeleccionada
    );
  }

  function filtrarDesempeño(datos, colorSeleccionado) {
    return datos.filter(d =>
      d.color === colorSeleccionado
    );
  }

  function filtrarUnidadIndicador(datos, unidadSeleccionada, indicadorSeleccionado) {
    return datos.filter(d =>
      d.unidad === unidadSeleccionada && d.indicador === indicadorSeleccionado
    );
  }

  function contarColores(datosFiltrados) {
    const conteo = {
      green: 0,
      red: 0,
      orange: 0,
      white: 0
    };
    datosFiltrados.forEach(d => {
      if (conteo[d.color] !== undefined) {
        conteo[d.color]++;
      }
    });

    return conteo;
  }

  function actualizarGrafica1(punto){
    var latitud_seleccionada = punto.lat;
    var longitud_seleccionada = punto.lon;
    
    Plotly.react('mapa', 
      [{
        type: 'scattergeo',
        mode: 'markers',
        lat: latitudes,  // latitudes
        lon: longitudes, // longitudes
        text: nombres,
        marker: {
          size: [
            '15','15','15','15','15','20','15','15','20','15','20','15','15','15','15','15','15','15','15','15','15','15','15','15','15','15','20','20'],// [20, 30]
          color: [
            'green','green','green','green','green','coral','green','green','coral','green','coral','green','green','green','green','green','green','green','green','green','green','green','green','green','green','green','coral','coral']//['green', 'red']
        },
        showlegend: false
      }],
      {
        title: {
          text: `${unidad_deseada}`,
          font: {
            size: 24,
            color: "black"
          },
          //xref: 'paper',
          x: 0.5, // Centrado
          xanchor: 'center'
        },
        geo: {
          scope: "north america",  // o usa 'north america' si quieres limitar
          projection: { type: "mercator" },
          center: { lat: latitud_seleccionada, lon: longitud_seleccionada },
          resolution: 60,
          lonaxis: { range: [-100, -94] },  // ajusta el área visible si quieres
          lataxis: { range: [16.3, 19.5] },
          showland: true,
          landcolor: "rgb(243, 243, 243)",
          countrycolor: "rgb(204, 204, 204)",
          projection: { scale: 1 }
        },
        //margin: { t: 50, b: 0, l: 0, r: 0 }
      }
    ); // mapa
    
    // Eliminar highlight anterior si existe
    if (document.getElementById('mapa').data.length > 1) {
      Plotly.deleteTraces('mapa', 1);
    }

    // Crear nuevo punto resaltado
    Plotly.addTraces('mapa', {
      type: 'scattergeo',
      mode: 'markers',
      lat: [latitud_seleccionada],
      lon: [longitud_seleccionada],
      marker: {
        size: 30,
        color: 'yellow',
        opacity: 0.5,
        line: {
          width: 4,
          color: 'gold'
        }
      },
      hoverinfo: 'skip',  // Opcional, para que no muestre tooltip
      showlegend: false
    }).then((res) => {
      console.log('Resaltando punto');
    });
  }

  function actualizarGrafica2(datos, unidad_deseada, fecha_deseada) {
    const datosFiltrados = filtrarUnidadFecha(datos, unidad_deseada, fecha_deseada);
    const conteo = contarColores(datosFiltrados);
    //const labels = ["Esperado", "Bajo", "Medio", "Sin datos"];
    const values = [conteo.green, conteo.red, conteo.orange, conteo.white];
    const colors = ["green", "red", "orange", "lightgray"];
    // console.log(datosFiltrados);
    Plotly.react("desempeños", 
      [{
        values: values,
        labels: labels,
        type: "pie",
        marker: {
          colors: colors
        },
        textinfo: "label+percent",
        insidetextorientation: "radial"
      }], 
      {
        title: {
          text: `Indicadores por Desempeño - ${unidad_deseada}`,
          font: {
            size: 24,
            color: "black"
          },
          x: 0.5
        }
      }
    );
    return datosFiltrados;
  }

  function actualizarGrafica3(datosFiltrados, desempeño){
    if (desempeño == labels[0]) {
      color_deseado = 'green';
    } else if (desempeño == labels[1]) {
      color_deseado = 'red';
    } else if (desempeño == labels[2]) {
      color_deseado = 'orange';
    } else {
      color_deseado = 'white';
    }

    const datosFiltrados2 = filtrarDesempeño(datosFiltrados, color_deseado);
    // Crear arrays para la gráfica
    const indicadores = datosFiltrados2.map(row => row['indicador']);
    const valores = datosFiltrados2.map(row => row['valor']);
    // console.log(datosFiltrados2);
    Plotly.react("indicadores_1", 
      [{
        x: indicadores,
        y: valores,
        type: "bar",
        marker: {
          color: color_deseado  // te explico abajo
        },
        textinfo: "label+percent",
      }], {
        title: {
          text: `Indicadores con desempeño ${desempeño}`,
          font: {
            size: 24,
            color: "black"
          },
          x: 0.5
        },
        xaxis: { title: "Indicador" },
        yaxis: { title: "Valor" }
      }
    );
    return indicadores;
  }

  function actualizarGrafica4(datos, unidad_deseada, indicador_deseado){
    const datosFiltrados3 = filtrarUnidadIndicador(datos, unidad_deseada, indicador_deseado);
    console.log(unidad_deseada, indicador_deseado);
    // Crear arrays para la gráfica
    const fechas = datosFiltrados3.map(row => row['fecha']);
    const valores = datosFiltrados3.map(row => row['valor']);
    const colores = datosFiltrados3.map(row => row['color']);
    // console.log(datosFiltrados3);
    Plotly.react("indicadores_2", [{
      x: fechas,
      y: valores,
      type: "bar",
      marker: {
        color: colores  // te explico abajo
      }
    }], {
      title: {
        text: `${indicador_deseado} - ${unidad_deseada}`,
        font: {
          size: 24,
          color: "black"
        },
        x: 0.5
      },
      xaxis: { title: "Fechas" },
      yaxis: { title: "Valor" }
    });
  }

  // -------------- COORDENADAS -------------------- //
  latitudes = [16.3673,16.5853,16.4342,16.5548,16.8022,16.2022,16.3296,18.1065,15.7617,18.0829,18.0822,15.7363,17.3319,16.7944,
               17.0782,17.0701,17.0672,16.8664,17.2101,17.2411,17.2818,17.7983,15.8635,18.1312,16.3395,17.6718,17.0723,17.0720];
  longitudes = [-94.1915,-94.7655,-95.0146,-95.0882,-95.0962,-95.2019,-95.2329,-95.8807,-96.1296,-96.1378,-96.1379,-96.4722,-96.4871,-96.6764,
                -96.7043,-96.7220,-96.7358,-96.7863,-96.7980,-96.8207,-96.8925,-96.9602,-97.0703,-97.0765,-98.0453,-97.5652,-96.7212,-96.7207];
  nombres = ['UMF 30 San Pedro Tapanatepec','UMF 12 Sto. Domingo Ingenio','UMF 06 Juchitán','UMF 23 Cd. Ixtepec','UMF 29 Barrio La Soledad',
             'HGZMF 02 Salina Cruz','UMF 05 Sto.Dgo.Tehuantepec','UMF 59 Loma Bonita','HGSMF 41 Huatulco','UMF 64 Tuxtepec','HGZ 03 Tuxtepec',
             'UMF 33 Pedro Pochutla','UMF 40 Ixtlan de Juárez','UMF 27 Ocotlán','UMF 65 Sta Lucia del Camino','UMF 01 Oaxaca','UMF 38 FFCC.',
             'UMF 31 Zimatlán de Álvarez','UMF 57 San Pablo Villa de Etla','UMF 17 Magdalena Apasco','UMF 56 San Pablo Huitzo','UMF 13 Cuicatlán',
             'UMF 32 Puerto Escondido','UMF 58 Teotitlán','UMF 26 Pinotepa','UMRM 21 Tamazulapan','HGZ 01 Oaxaca','UMAA Oaxaca'];

  mes_deseado = 'ENERO';
  año_deseado = '2025';
  fecha_deseada = mes_deseado.concat(' ', año_deseado);
  desempeño = 'Bajo';
  color_deseado = 'red';
  unidad_deseada = 'Oaxaca';
  indicador_deseado = 'DM 01';
  labels = ["Esperado", "Bajo", "Medio", "Sin datos"];
  puntoResaltado = null;

  fetch("https://script.google.com/macros/s/AKfycbxbdwnq17ukuBOPxtHR52a12NcrR4V5LiTujKCPFWMKoYztEFmIBk6pyeyHG2UwVMamog/exec")
    .then(response => response.json())
    .then(data => {
      datos = data.map(row => ({
        fecha: row["FECHA"],
        unidad: row["UNIDAD"],
        ind: row["IND"],
        indicador: row["INDICADOR"],
        nombre_indicador: row["NOMBRE INDICADOR"],
        valor: parseFloat(row["VALOR"]),
        color: calcularColor(row["VALOR"], row["ESPERADO"], row["MEDIO"], row["BAJO"])
      }));

    console.log("Termina de preparar los datos. Comienza a graficar.");
    datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada);
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
  });

  Plotly.newPlot('mapa', 
    [{
      type: 'scattergeo',
      mode: 'markers',
      lat: latitudes,  // latitudes
      lon: longitudes, // longitudes
      text: nombres,
      marker: {
        size: [
          '15','15','15','15','15','20','15','15','20','15','20','15','15','15','15','15','15','15','15','15','15','15','15','15','15','15','20','20'],// [20, 30]
        color: [
          'green','green','green','green','green','coral','green','green','coral','green','coral','green','green','green','green','green','green','green','green','green','green','green','green','green','green','green','coral','coral']//['green', 'red']
      },
      showlegend: false
    }],
    {
      title: {
        text: 'Ubicación de Unidades de OOAD OAXACA',
        font: {
          size: 24,
          color: "black"
        },
        //xref: 'paper',
        x: 0.5, // Centrado
        xanchor: 'center'
      },
      geo: {
        scope: "north america",  // o usa 'north america' si quieres limitar
        projection: { type: "mercator" },
        center: { lat: 17.2, lon: -96.2 },
        resolution: 150,
        lonaxis: { range: [-100, -94] },  // ajusta el área visible si quieres
        lataxis: { range: [16.3, 19.5] },
        showland: true,
        landcolor: "rgb(243, 243, 243)",
        countrycolor: "rgb(204, 204, 204)",
        projection: { scale: 1 }
      },
      //margin: { t: 50, b: 0, l: 0, r: 0 }
    }
  ); // mapa

  Plotly.newPlot("desempeños", 
  [{
    values: [1, 0, 0, 0],
    labels: labels,
    type: "pie",
    marker: { colors: ["green", "red", "orange", "lightgray"] },
    textinfo: "label+percent",
    insidetextorientation: "radial"
  }], {
    title: {
      text: `Indicadores por Desempeño`,
      x: 0.5
    }
  }); // desempeños

  Plotly.newPlot("indicadores_1", 
    [{
      x: [1, 0, 0, 0],
      y: ['01', '02', '03', '04'],
      type: "bar",
      marker: {
        color: color_deseado
      }
    }], {
      title: {
        text: `Indicadores con desempeño ${desempeño}`,
        x: 0.5
      },
      xaxis: { title: "Indicador" },
      yaxis: { title: "Valor" }
    }); // indicadores_1

  Plotly.newPlot("indicadores_2", 
    [{
      x: [1, 0, 0, 0],
      y: ['Enero', 'Febrero', 'Marzo', 'Abril'],
      type: "bar",
      marker: {
        color: color_deseado 
      }
    }], {
      title: {
        text: `${indicador_deseado} - ${unidad_deseada}`,
        x: 0.5
      },
      //xaxis: { title: "Fechas" },
      yaxis: { title: "Valor" }
    }); // indicadores_1

  console.log('Terminó una gráfica, empezando a comunicarse.');

  document.getElementById("mapa").on('plotly_click', function(data2) {
    var punto = data2.points[0];
    unidad_deseada = punto.text;
    console.log("Clic en:", unidad_deseada);

    // Actualizando Graficas
    actualizarGrafica1(punto);
    datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada);
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
  });

  document.getElementById("desempeños").on('plotly_click', function(data3) {
    var punto = data3.points[0];
    desempeño = punto.label;
    console.log(desempeño);
    // Actualizando Graficas
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
  });

  document.getElementById("indicadores_1").on('plotly_click', function(data4) {
    var punto = data4.points[0];
    indicador_deseado = punto.label;
    console.log(desempeño);
    // Actualizando Graficas
    actualizarGrafica4(datos, unidad_deseada, indicador_deseado);
  });
  </script>
</body>
</html>
