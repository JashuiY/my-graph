<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Desde Google Sheets</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      background: #f8f8f8; 
    }
    .controls, .right-buttons { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      margin-bottom: 20px; 
    }
    .right-buttons { 
      flex-direction: column; 
      margin-left: 40px; 
    }
    .toggle { 
      cursor: pointer; 
      border: 1px solid #ccc; 
      padding: 6px 10px; 
      border-radius: 6px; 
      background: white; 
    }
    .toggle.active { 
      background-color: #007bff; 
      color: white; 
    }
    .btn { 
      padding: 8px 12px; 
      background: #e6f3e6; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      cursor: pointer; 
      width: 100px; 
      text-align: center; 
    }
    .btn.active { 
      background: green; 
      color: white; 
      font-weight: bold; 
    }
    #chart-container { 
      display: flex; 
    }
    #chart { 
      width: 700px; 
      height: 400px; 
    }
    .contenedor {
      display: flex;
      gap: 20px; /* Espacio entre gráficos */
      margin-bottom: 20px;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
      align-items: center;
    }
    .grafica {
      flex: 1;
      height: 500px;
    }
    #mapa {
      flex: 1;
      max-width: 60%;
    }
    #desempeños {
      flex: 1;
      max-width: 40%;
    }
    /*style="width: 50%; max-width: 900px; height: 500px;"*/
  </style>
</head>
<body>
  <h2><center>INDICADORES – OOAD OAXACA</center></h2>
  <div class="contenedor">
    <div id="mapa" class="grafica"></div>
    <div id="desempeños" class="grafica"></div>
  </div>
  <div class="contenedor">
    <div id="indicadores_1" class="grafica"></div>
  </div>
  <div id='texto_1' class="contenedor"> Análisis </div>
  <div class="contenedor">
    <div id="indicadores_2" class="grafica"></div>    
  </div>

  <script>
  function obtenerRangoNumero(valor){
    if (valor == null || valor === "") {
      return null;
    }
    valor = valor.toString();
    valor = valor.trim();

    if (valor.includes("o")) {
      const partes = valor.split("o").map(v => v.trim());
      return partes.map(parte => obtenerRangoNumero(parte)); // Recursivo para limpiar cada parte
    }

    if (valor.includes("-")) {
      const partes = valor.split("-").map(v => parseFloat(v.trim()));
      return [partes[0], partes[1]];
    } else if (valor.startsWith(">=")) {
      return parseFloat(valor.substring(2).trim()) // { tipo: "mayorIgual", valor: parseFloat(valor.substring(2).trim()) };
    } else if (valor.startsWith("<=")) {
      return parseFloat(valor.substring(2).trim()) // { tipo: "menorIgual", valor: parseFloat(valor.substring(2).trim()) };
    } else if (valor.startsWith(">")) {
      return parseFloat(valor.substring(1).trim()) // { tipo: "mayor", valor: parseFloat(valor.substring(1).trim()) };
    } else if (valor.startsWith("<")) {
      return parseFloat(valor.substring(1).trim()) // { tipo: "menor", valor: parseFloat(valor.substring(1).trim()) };
    } else {
      return parseFloat(valor);
    }
  }

  function evaluarCondicion(numero, condicionTexto) {
    if (!condicionTexto) return false;
    // Normalizar: quitar espacios, pasar a minúscula
    condicionTexto = condicionTexto.toLowerCase().replace(/\s+/g, "");
    // console.log('evaluando..', numero, condicionTexto)
    // Dividir por "o" (también podrías usar "|" o "," si quisieras)
    const condiciones = condicionTexto.split("o");
    // Evaluar cada subcondición
    return condiciones.some(cond => {
      if (/^\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'===', cond)
        return numero === parseFloat(cond);

      } else if (/^<=\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'<=', cond.slice(2))
        return numero <= parseFloat(cond.slice(2));

      } else if (/^>=\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'>=', cond.slice(2))
        return numero >= parseFloat(cond.slice(2));

      } else if (/^<\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'<', cond.slice(1))
        return numero < parseFloat(cond.slice(1));

      } else if (/^>\d+(\.\d+)?$/.test(cond)) {
        //console.log(numero,'>', cond.slice(1))
        return numero > parseFloat(cond.slice(1));

      } else if (/^\d+(\.\d+)?-\d+(\.\d+)?/.test(cond)) {
        const [inicio, fin] = cond.split("-").map(Number);
        //console.log(numero,'>=', inicio, '&&', numero, '<=', fin)
        return numero >= inicio && numero <= fin;
      }
      return false;
    });
  }  
  
  function calcularColor(valor, esperado, medio, bajo) {
    if (evaluarCondicion(valor, esperado)) {
      return "green";
    } else if (evaluarCondicion(valor, medio)) {
      return "orange";
    } else if (evaluarCondicion(valor, bajo)) {
      return "red";
    } else {
      return "white";
    }
  }

  function filtrarUnidadFecha(datos, unidadSeleccionada, fechaSeleccionada) {
    return datos.filter(d =>
      d.unidad === unidadSeleccionada && d.fecha === fechaSeleccionada
    );
  }

  function filtrarDesempeño(datos, colorSeleccionado) {
    return datos.filter(d =>
      d.color === colorSeleccionado
    );
  }

  function filtrarUnidadIndicador(datos, unidadSeleccionada, indicadorSeleccionado) {
    return datos.filter(d =>
      d.unidad === unidadSeleccionada && d.indicador === indicadorSeleccionado
    );
  }

  function contarColores(datosFiltrados) {
    const conteo = {
      green: 0,
      red: 0,
      orange: 0,
      white: 0
    };
    datosFiltrados.forEach(d => {
      if (conteo[d.color] !== undefined) {
        conteo[d.color]++;
      }
    });

    return conteo;
  }

  function actualizarGrafica1(punto){
    var latitud_seleccionada = punto.lat;
    var longitud_seleccionada = punto.lon;
    
    Plotly.react('mapa', 
      [{
        type: 'scattergeo',
        mode: 'markers',
        lat: latitudes,  // latitudes
        lon: longitudes, // longitudes
        text: nombres,
        marker: {
          size: [
            '15','15','15','15','15','20','15','15','20','15','20','15','15','15','15','15','15','15','15','15','15','15','15','15','15','15','20','20'],// [20, 30]
          color: [
            'green','green','green','green','green','coral','green','green','coral','green','coral','green','green','green','green','green','green','green','green','green','green','green','green','green','green','green','coral','coral']//['green', 'red']
        },
        showlegend: false
      }],
      {
        title: {
          text: `${unidad_deseada}`,
          font: {
            size: 24,
            color: "black"
          },
          //xref: 'paper',
          x: 0.5, // Centrado
          xanchor: 'center'
        },
        geo: {
          scope: "north america",  // o usa 'north america' si quieres limitar
          projection: { type: "mercator" },
          center: { lat: latitud_seleccionada, lon: longitud_seleccionada },
          resolution: 60,
          lonaxis: { range: [-100, -94] },  // ajusta el área visible si quieres
          lataxis: { range: [16.3, 19.5] },
          showland: true,
          landcolor: "rgb(243, 243, 243)",
          countrycolor: "rgb(204, 204, 204)",
          projection: { scale: 1 }
        },
        //margin: { t: 50, b: 0, l: 0, r: 0 }
      }
    ); // mapa
    
    // Eliminar highlight anterior si existe
    if (document.getElementById('mapa').data.length > 1) {
      Plotly.deleteTraces('mapa', 1);
    }

    // Crear nuevo punto resaltado
    Plotly.addTraces('mapa', {
      type: 'scattergeo',
      mode: 'markers',
      lat: [latitud_seleccionada],
      lon: [longitud_seleccionada],
      marker: {
        size: 30,
        color: 'yellow',
        opacity: 0.5,
        line: {
          width: 4,
          color: 'gold'
        }
      },
      hoverinfo: 'skip',  // Opcional, para que no muestre tooltip
      showlegend: false
    }).then((res) => {
      console.log('Resaltando punto');
    });
  }

  function actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño) {
    const datosFiltrados = filtrarUnidadFecha(datos, unidad_deseada, fecha_deseada);
    const conteo = contarColores(datosFiltrados);
    //const labels = ["Esperado", "Bajo", "Medio", "Sin datos"];
    const pulled = [0, 0, 0, 0];
    const values = [conteo.green, conteo.red, conteo.orange, conteo.white];
    const colors = ["green", "red", "orange", "lightgray"];

    index_color = labels.indexOf(desempeño);
    pulled[index_color] = 0.1;
    n_indicadores = values[index_color];

    titulo = unidad_deseada;
    const reg_exp = /(?<=\d{2})\s/;
    titulo = titulo.replace(reg_exp, "<br>");

    // console.log(datosFiltrados);
    Plotly.react("desempeños", 
      [{
        values: values,
        labels: labels,
        type: "pie",
        marker: {
          colors: colors
        },
        textinfo: "label+percent",
        insidetextorientation: "radial",
        pull: pulled,
        hole: 0.3,
        textfont: {
          size: 18
        },
        hoverinfo: 'none',//'label+percent+value',
        hovertemplate: '', //'<b>%{label}</b><br>%{percent:.1%}<br>Valor: %{value}<extra></extra>',
      }], 
      {
        title: {
          text: `${titulo}`,
          font: {
            size: 24,
            color: "black"
          },
          x: 0.5,
          //position: "center middle"
        },
        annotations: [{  // Texto en el centro
          text: `No.<br>indicadores:<br><br><span style="font-size:30px; margin:25px;">${n_indicadores}</span>`,
          font: { family: 'Noto Sans', size: 14, color: '#333' },
          showarrow: false,
          x: 0.5,  // Posición X (0-1)
          y: 0.5,  // Posición Y (0-1)
          xanchor: 'center',
          yanchor: 'middle',
          align: 'center'
        }],
        showlegend: false,
        hoverlabel: {
          shadow: {
            color: 'rgba(0,0,0,0.5)',
            x: 3,
            y: 3,
            blur: 10
          }
        },
        plot_bgcolor: 'rgba(0,0,0,0)', // Fondo transparente
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, b: 40, l: 30, r: 30 }, // Márgenes ajustados
        font: {
          family: 'Noto Sans',
          color: '#333333'
        },
        hovermode: 'closest',
        animations: {
          enabled: true,
          easing: 'elastic-in-out'
        }
      }
    );
    return datosFiltrados;
  }

  function actualizarGrafica3(datosFiltrados, desempeño){
    if (desempeño == labels[0]) {
      color_deseado = 'green';
    } else if (desempeño == labels[1]) {
      color_deseado = 'red';
    } else if (desempeño == labels[2]) {
      color_deseado = 'orange';
    } else {
      color_deseado = 'white';
    }

    const datosFiltrados2 = filtrarDesempeño(datosFiltrados, color_deseado);
    // 1. Calcular diferencia absoluta valor - esperado
      let esperado;
    const datosConError = datosFiltrados2.map(row => {
      if (desempeño == 'Bajo') {
        esperado = (row['medio'] != null) ? row['medio'] : row['esperado'];
      } else if (desempeño == 'Medio'){
        esperado = row['esperado'];
      } else if (desempeño == 'Esperado'){
        esperado = (row['medio'] != null) ? row['medio'] : row['bajo'];
      }
      let error;

      if (Array.isArray(esperado)) {
        errorMin = Math.abs(row['valor'] - parseFloat(esperado[0]));
        errorMax = Math.abs(row['valor'] - parseFloat(esperado[1]));
        error = Math.min(errorMin, errorMax);
      } else {
        error = Math.abs(row['valor'] - parseFloat(esperado));
      }

      return {
        indicador: row['indicador'],
        error: error,
        valor: row['valor'],
        limite: esperado,
      };
    });

    // 2. Ordenar por error de menor a mayor
    datosConError.sort((a, b) => a.error - b.error);
    console.log(datosConError);
    /*
    */
    // Crear arrays para la gráfica
    const indicadores = datosConError.map(row => row.indicador);
    const valores = datosConError.map(row => row.valor);
    const textos = valores.map(String);
    // console.log(valores, textos);
    console.log(datosFiltrados2);
    Plotly.react("indicadores_1", 
      [{
        type: "bar",
        x: indicadores,
        y: valores,
        text: textos,
        textposition: 'outside',
        cliponaxis: false,
        texttemplate: '%{y:.1f}',
        textangle: -90,
        textfont: {
          size: 18, 
          family: 'Noto Sans'
        },
        marker: {
          color: color_deseado 
        },
        hovertemplate: '<b>%{label}</b><br>%{value:.2f}<extra></extra>',
        hoverlabel: {
          bgcolor: color_deseado,
          //bordercolor: '#000000',
          font: { family: 'Noto Sans', color: (color_deseado=='orange' ? 'black':'white'), size: 16}
        },
        margin: { b: 150 }
      }], {
        title: {
          text: `Indicadores con desempeño ${desempeño}, ${mes_deseado} ${año_deseado}`,
          font: {
            size: 24,
            color: "black"
          },
          x: 0.5
        },
        //xaxis: { title: "Indicador" },
        yaxis: { title: "Valor" },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: '#f9f9f9',
        shadow: {
          enabled: true,
          color: 'rgba(0,0,0,0.2)',
          x: 3,
          y: 3,
          blur: 10
        },
        uniformtext: {
          //mode: 'hide', // Oculta etiquetas que no caben
          minsize: 14   // Tamaño mínimo de fuente
        }
      }
    );
    document.getElementById('texto_1').innerHTML = (`Hola ${indicadores.slice(0,5)} - \n`);
    return indicadores;
  }

  function actualizarGrafica4(datos, unidad_deseada, indicador_deseado){
    const datosFiltrados3 = filtrarUnidadIndicador(datos, unidad_deseada, indicador_deseado);
    console.log(unidad_deseada, indicador_deseado);
    // Crear arrays para la gráfica
    const fechas = datosFiltrados3.map(row => row['fecha']);
    const valores = datosFiltrados3.map(row => row['valor']);
    const colores = datosFiltrados3.map(row => row['color']);
    // console.log(datosFiltrados3);
    Plotly.react("indicadores_2", [{
      x: fechas,
      y: valores,
      type: "bar",
      marker: {
        color: colores  // te explico abajo
      }
    }], {
      title: {
        text: `${indicador_deseado} - ${unidad_deseada}`,
        font: {
          size: 24,
          color: "black"
        },
        x: 0.5
      },
      xaxis: { title: "Fechas" },
      yaxis: { title: "Valor" }
    });
  }

  // -------------- COORDENADAS -------------------- //
  latitudes = [16.3673,16.5853,16.4342,16.5548,16.8022,16.2022,16.3296,18.1065,15.7617,18.0829,18.0822,15.7363,17.3319,16.7944,
               17.0782,17.0701,17.0672,16.8664,17.2101,17.2411,17.2818,17.7983,15.8635,18.1312,16.3395,17.6718,17.0723,17.0720];
  longitudes = [-94.1915,-94.7655,-95.0146,-95.0882,-95.0962,-95.2019,-95.2329,-95.8807,-96.1296,-96.1378,-96.1379,-96.4722,-96.4871,-96.6764,
                -96.7043,-96.7220,-96.7358,-96.7863,-96.7980,-96.8207,-96.8925,-96.9602,-97.0703,-97.0765,-98.0453,-97.5652,-96.7212,-96.7207];
  nombres = ['UMF 30 San Pedro Tapanatepec','UMF 12 Sto. Domingo Ingenio','UMF 06 Juchitán','UMF 23 Cd. Ixtepec','UMF 29 Barrio La Soledad',
             'HGZMF 02 Salina Cruz','UMF 05 Sto.Dgo.Tehuantepec','UMF 59 Loma Bonita','HGSMF 41 Huatulco','UMF 64 Tuxtepec','HGZ 03 Tuxtepec',
             'UMF 33 Pedro Pochutla','UMF 40 Ixtlan de Juárez','UMF 27 Ocotlán','UMF 65 Sta Lucia del Camino','UMF 01 Oaxaca','UMF 38 FFCC.',
             'UMF 31 Zimatlán de Álvarez','UMF 57 San Pablo Villa de Etla','UMF 17 Magdalena Apasco','UMF 56 San Pablo Huitzo','UMF 13 Cuicatlán',
             'UMF 32 Puerto Escondido','UMF 58 Teotitlán','UMF 26 Pinotepa','UMRM 21 Tamazulapan','HGZ 01 Oaxaca','UMAA Oaxaca'];

  mes_deseado = 'ENERO';
  año_deseado = '2025';
  fecha_deseada = mes_deseado.concat(' ', año_deseado);
  desempeño = 'Bajo';
  color_deseado = 'red';
  unidad_deseada = 'Oaxaca';
  indicador_deseado = 'DM 01';
  labels = ["Esperado", "Bajo", "Medio", "Sin datos"];
  puntoResaltado = null;
  n_indicadores = "--";

  fetch("https://script.google.com/macros/s/AKfycbxbdwnq17ukuBOPxtHR52a12NcrR4V5LiTujKCPFWMKoYztEFmIBk6pyeyHG2UwVMamog/exec")
    .then(response => response.json())
    .then(data => {
      datos = data.map(row => ({
        fecha: row["FECHA"],
        unidad: row["UNIDAD"],
        ind: row["IND"],
        indicador: row["INDICADOR"],
        nombre_indicador: row["NOMBRE INDICADOR"],
        valor: parseFloat(row["VALOR"]),
        color: calcularColor(row["VALOR"], row["ESPERADO"], row["MEDIO"], row["BAJO"]),
        esperado: obtenerRangoNumero(row['ESPERADO']),
        medio: obtenerRangoNumero(row['MEDIO']),
        bajo: obtenerRangoNumero(row['BAJO'])
      }));
    console.log(datos);
    console.log("Termina de preparar los datos. Comienza a graficar.");
    datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño);
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
  });

  Plotly.newPlot('mapa', 
    [{
      type: 'scattergeo',
      mode: 'markers',
      lat: latitudes,  // latitudes
      lon: longitudes, // longitudes
      text: nombres,
      marker: {
        size: [
          '15','15','15','15','15','20','15','15','20','15','20','15','15','15','15','15','15','15','15','15','15','15','15','15','15','15','20','20'],// [20, 30]
        color: [
          'green','green','green','green','green','coral','green','green','coral','green','coral','green','green','green','green','green','green','green','green','green','green','green','green','green','green','green','coral','coral']//['green', 'red']
      },
      showlegend: false
    }],
    {
      title: {
        text: 'Ubicación de Unidades de OOAD OAXACA',
        font: {
          size: 24,
          color: "black"
        },
        //xref: 'paper',
        x: 0.5, // Centrado
        xanchor: 'center'
      },
      geo: {
        scope: "north america",  // o usa 'north america' si quieres limitar
        projection: { type: "mercator" },
        center: { lat: 17.2, lon: -96.2 },
        resolution: 150,
        lonaxis: { range: [-100, -94] },  // ajusta el área visible si quieres
        lataxis: { range: [16.3, 19.5] },
        showland: true,
        landcolor: "rgb(243, 243, 243)",
        countrycolor: "rgb(204, 204, 204)",
        projection: { scale: 1 }
      },
      //margin: { t: 50, b: 0, l: 0, r: 0 }
    }
  ); // mapa

  Plotly.newPlot("desempeños", 
  [{
    values: [1, 0, 0, 0],
    labels: labels,
    type: "pie",
    marker: { colors: ["green", "red", "orange", "lightgray"] },
    textinfo: "label+percent",
    insidetextorientation: "radial"
  }], {
    title: {
      text: `Indicadores por Desempeño`,
      x: 0.5
    },
    animations: {
      enabled: true,
      easing: 'elastic-in-out'
    }
  }); // desempeños

  Plotly.newPlot("indicadores_1", 
    [{
      x: [1, 0, 0, 0],
      y: ['01', '02', '03', '04'],
      type: "bar",
      marker: {
        color: color_deseado
      }
    }], {
      title: {
        text: `Indicadores con desempeño ${desempeño}`,
        x: 0.5
      },
      xaxis: { title: "Indicador" },
      yaxis: { title: "Valor" }
    }); // indicadores_1

  Plotly.newPlot("indicadores_2", 
    [{
      x: [1, 0, 0, 0],
      y: ['Enero', 'Febrero', 'Marzo', 'Abril'],
      type: "bar",
      marker: {
        color: color_deseado 
      }
    }], {
      title: {
        text: `${indicador_deseado} - ${unidad_deseada}`,
        x: 0.5
      },
      //xaxis: { title: "Fechas" },
      yaxis: { title: "Valor" }
    }); // indicadores_2

  console.log('Terminó una gráfica, empezando a comunicarse.');

  document.getElementById("mapa").on('plotly_click', function(data2) {
    var punto = data2.points[0];
    unidad_deseada = punto.text;
    console.log("Clic en:", unidad_deseada, punto);
    n_indicadores = "--";

    // Actualizando Graficas
    actualizarGrafica1(punto);
    datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño);
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
  });

  document.getElementById("desempeños").on('plotly_click', function(data3) {
    var punto = data3.points[0];
    desempeño = punto.label;
    n_indicadores = punto.value;
    console.log(desempeño);
    // Actualizando Graficas
    datosFiltrados = actualizarGrafica2(datos, unidad_deseada, fecha_deseada, desempeño);
    indicadores_d = actualizarGrafica3(datosFiltrados, desempeño); // devuelve lista de indicadores graficados.
    actualizarGrafica4(datos, unidad_deseada, indicadores_d[0]);
  });

  document.getElementById("indicadores_1").on('plotly_click', function(data4) {
    var punto = data4.points[0];
    indicador_deseado = punto.label;
    console.log(desempeño);
    // Actualizando Graficas
    actualizarGrafica4(datos, unidad_deseada, indicador_deseado);
  });
  </script>
</body>
</html>
